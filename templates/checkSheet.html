<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>체크시트 페이지</title>
    <!-- Font Awesome 아이콘 라이브러리 추가 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <!-- Font Awesome 추가 -->
    <style>
        /* 전체 페이지 스타일 설정 */
        body, input, button, select {
            font-size: 20px;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            color: #333;
            display: flex;
            transition: margin-right 0.5s;
        }
        h1 {
            color: #0056b3;
        }
        form {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 20px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            background-color: #45a049;
        }
        button:active {
            background-color: #3e8c43;
            transform: scale(0.98);
        }
        /* 캔버스 스타일 설정 */
        canvas {
            border: 1px solid #000000;
            touch-action: none;

        }
        /* 에러 메시지 스타일 */
        #error {
            color: red;
        }
        #drawingCanvas {
            cursor: url("{{ pen_cursor_url }}"), auto; /* 캔버스 위에서 마우스 커서를 펜 모양으로 변경 */
        }
        /* 사이드바 스타일 설정 */
        .sidebar {
            height: 100vh;
            width: 50px; /* 초기 너비 설정 */
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: width 0.5s;
            padding-top: 20px;
        }
        /* 사이드바 링크 스타일 */
        .sidebar a {
            padding: 10px 15px;
            text-decoration: none;
            font-size: 25px;
            color: white;
            display: block;
            transition: 0.3s;
        }
        .sidebar a:hover {
            color: #f1f1f1;
        }
        .sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }
        .link-text {
            display: inline; /* 기본적으로 텍스트 표시 */
        }
        /* 사이드바 확장/축소 시 스타일 변경 */
        .sidebar.collapsed .link-text {
            display: none; /* 축소된 상태에서는 텍스트 숨김 */
        }

        .sidebar:not(.collapsed) .link-text {
            display: inline; /* 확장된 상태에서 텍스트 표시 */
        }

        .sidebar.collapsed {
            width: 50px; /* 축소된 상태의 사이드바 너비 */
        }

        .sidebar:not(.collapsed) {
            width: 250px; /* 확장된 상태의 사이드바 너비 */
        }
        .sidebar.collapsed + #main {
            margin-left: 50px; /* 사이드바가 축소되었을 때의 marginLeft */
        }

        .sidebar:not(.collapsed) + #main {
            margin-left: 250px; /* 사이드바가 확장되었을 때의 marginLeft */
        }
        /* 메인 컨텐츠 영역 스타일 */
        #main {
            transition: margin-right 0.5s, margin-left 0.5s ease;
            padding: 16px;
            flex-grow: 1;
            margin-right: 50px; /* 초기 marginRight 설정 */
        }
        .openbtn {
            font-size: 20px;
            cursor: pointer;
            background-color: #111;
            color: white;
            border: none;
            position: fixed;
            top: 10px;
            left: 10px;
            width: 50px; /* 너비 조정 */
            height: 50px; /* 높이 조정 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar.collapsed .openbtn {
            left: calc(50px - 50px / 2); /* 축소된 사이드바 중앙에 위치 */
        }
        .openbtn:hover {
            background-color: #444;
        }

        /* 메시지 컨테이너 스타일 */
        #messages-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 개별 메시지 스타일 */
        .message {
            background-color: #f44336; /* 기본 빨간색 */
            color: white; /* 흰색 텍스트 */
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
            transition: opacity 0.5s ease;
            min-width: 200px;
            text-align: center;
        }

        /* 메시지가 사라질 때의 효과 */
        .message.hide {
            opacity: 0;
        }
    </style>
<body onload="focusOnBarcodeInput()">
    <!-- 사이드바 구조 -->
    <div id="mySidebar" class="sidebar collapsed">
        <!-- 사이드바 메뉴 항목들 -->
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
        <a href="/login"><i class="fa fa-home"></i><span class="link-text"> 로그인</span></a>
        <a href="#"><i class="fa fa-check-square-o"></i><span class="link-text"> 체크시트</span></a>
        <!-- <a href="/mount-label"><i class="fa fa-camera"></i><span class="link-text"> 마운트라벨 등록</span></a> -->
        <a href="/checksheet-history"><i class="fa fa-history"></i><span class="link-text"> 이력관리</span></a>
        <a href="/logout"><i class="fa fa-sign-out"></i><span class="link-text"> 로그아웃</span></a>
    </div>
    <!-- 사이드바 토글 버튼 -->
    <button class="openbtn" onclick="toggleNav()">☰</button> <!-- 기존의 햄버거 메뉴 아이콘을 사용 -->
    <!-- 메인 컨텐츠 영역 -->
    <div id="main">
        <h1>체크시트 페이지</h1>
        <!-- 사용자 정보 표시 -->
        <p><strong>담당 작업자:</strong> <span id="employeeName"></span></p>
        <p><strong>담당 라인:</strong> <span id="deptInfo"></span></p>
        <!-- 바코드 입력 폼 -->
        <form id="barcode-form">
            <!-- 공정 선택 드롭다운 -->
            <label for="processSelect">공정 선택:</label> 
            <select id="processSelect" name="processSelect">
                <!-- 공정 옵션들 -->
                <option value="08">부품SET</option>
                <option value="06">단자체결기</option>
                <option value="11">조립</option>
                <option value="15">출하검사</option>
            </select>
            <br><br>
            <!-- 바코드 입력 필드 -->
            <label for="barcodeInput">바코드 입력:</label>
            <input type="text" id="barcodeInput" name="barcodeInput" autofocus inputmode="ascii" oninput="validateInput(this);" />
            <input type="submit" value="Submit" style="display: none;">
            <!-- 제품 정보 표시 영역 -->
            <p><strong>Index No:</strong> <span id="indexNo"></span></p>   
            <p><strong>MS-CODE:</strong> <span id="msCode"></span></p>
            <p><strong>Serial No:</strong> <span id="serialNo"></span></p>
            <!-- 에러 메시지 표시 영역 -->
            <p id="error" style="color: red;"></p>
            <!-- 체크 완료 버튼 -->
            <button type="button" id="checkCompleteButton" style="display: none;">체크 완료</button>
            <!-- 이미지 표시 영역 -->
            <div id="canvasContainer" style="display: none; position: relative; width: 800px; height: 600px;">
                <canvas id="baseImageCanvas" width="800" height="600" style="position: absolute; border:1px solid #000000;"></canvas>
                <canvas id="drawingCanvas" width="800" height="600" style="position: absolute; border:1px solid #000000;"></canvas>
            </div>
        </form>
    </div>

    <!-- 메시지 컨테이너 추가 -->
    <div id="messages-container"></div>

    <script>
        // focusOnBarcodeInput 함수 정의
        function focusOnBarcodeInput() {
            document.getElementById('barcodeInput').focus();
        }
        // 변수 선언
        const barcodeInput = document.getElementById('barcodeInput');
        const indexNoDisplay = document.getElementById('indexNo');    
        const msCodeDisplay = document.getElementById('msCode');
        const serialNoDisplay = document.getElementById('serialNo');
        const errorDisplay = document.getElementById('error');
        const form = document.getElementById('upload-form');
        const baseImageCanvas = document.getElementById('baseImageCanvas');
        const drawingCanvas = document.getElementById('drawingCanvas');
        const baseCtx = baseImageCanvas.getContext('2d');
        const drawingCtx = drawingCanvas.getContext('2d');

        let is_checked_image = false;

        // 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', function() {
            const drawingCanvas = document.getElementById('drawingCanvas');
            const barcodeInput = document.getElementById('barcodeInput');
            const checkCompleteButton = document.getElementById('checkCompleteButton');

            // 오른쪽 클릭 방지
            drawingCanvas.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });

            // 체크박스 클릭 이벤트 핸들러
            drawingCanvas.addEventListener('click', function(event) {
                event.preventDefault(); // 기본 동작 방지
                event.stopPropagation(); // 이벤트 버블링 방지
                
                const rect = drawingCanvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                const selectedProcess = document.getElementById('processSelect').value;

                // 체크박스 클릭 이벤트 처리
                const clickedCheckbox = checkBoxes.find((checkBox, index) => 
                    x >= checkBox.x - 10 && x <= (checkBox.x + checkBox.width + 10) && 
                    y >= checkBox.y - 5 && y <= (checkBox.y + checkBox.height + 5)
                );

                if (clickedCheckbox) {
                    const index = checkBoxes.indexOf(clickedCheckbox);
                    const centerX = clickedCheckbox.x + clickedCheckbox.width / 2;
                    const centerY = clickedCheckbox.y + clickedCheckbox.height / 2;
                    const state = checkBoxStates[index] || 'default';

                    console.log(`체크박스 ${index} 클릭 전 상태: ${state}`);

                    // 체크박스 상태에 따라 이미지 그리기
                    switch (state) {
                        case 'default':
                            drawCheck(centerX, centerY);
                            checkBoxStates[index] = 'checked';
                            break;
                        case 'checked':
                            clearCheckboxVisual(index);
                            drawCross(centerX, centerY);
                            checkBoxStates[index] = 'crossed';
                            break;
                        case 'crossed':
                            clearCheckboxVisual(index);
                            drawCircleAndCheck(centerX, centerY);
                            checkBoxStates[index] = 'rechecked';
                            break;
                        case 'rechecked':
                            clearCheckboxVisual(index);   
                            checkBoxStates[index] = 'default';
                            break;
                    }

                    console.log(`체크박스 ${index} 클릭 후 상태: ${checkBoxStates[index]}`);

                    checkAllBoxesChecked();
                }
                
                // 바코드 입력 필드의 포커스 해제
                document.getElementById('barcodeInput').blur();
            });

            // 모든 체크박스가 체크되었는지 확인하는 함수
            function checkAllBoxesChecked() {
                if (is_checked_image) return; // 기존 이미지인 경우 함수 종료

                const allChecked = checkBoxes.every((box, index) => 
                    checkBoxStates[index] && checkBoxStates[index] !== 'default'
                );

                // if (allChecked) {
                //     checkCompleteButton.click();
                // }
            }
        });

        // 초기 설정 및 이벤트 리스너
        document.addEventListener('DOMContentLoaded', () => {
            var sidebar = document.getElementById("mySidebar");
            var main = document.getElementById("main");
            var openbtn = document.querySelector(".openbtn");

            // 사이드바 초기 상태 설정: 축소
            sidebar.classList.add('collapsed');
            sidebar.style.width = "50px";
            main.style.marginLeft = "50px";
            openbtn.innerHTML = "☰"; // 햄버거 아이콘 설정

            var employeeNameElement = document.getElementById('employeeName');
            var deptInfoElement = document.getElementById('deptInfo');
            
            if (employeeNameElement && deptInfoElement) {
                employeeNameElement.textContent = '{{ employee_name }}';
                deptInfoElement.textContent = '{{ dept_info }}';
            }
        });

        // 사이드바 토글 함수
        function toggleNav() {
            var sidebar = document.getElementById("mySidebar");
            var main = document.getElementById("main");
            var openbtn = document.querySelector(".openbtn");

            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                sidebar.style.width = "250px";
                main.style.marginLeft = "250px";
                openbtn.innerHTML = "×"; // 'X' 아이콘으로 변경
            } else {
                sidebar.classList.add('collapsed');
                sidebar.style.width = "50px";
                main.style.marginLeft = "50px";
                openbtn.innerHTML = "☰"; // 햄버거 아이콘으로 변경
            }
        }

        function closeNav() {
            var sidebar = document.getElementById("mySidebar");
            var main = document.getElementById("main");
            var openbtn = document.querySelector(".openbtn");

            sidebar.classList.add('collapsed');
            sidebar.style.width = "50px";
            main.style.marginLeft = "50px";
            openbtn.innerHTML = "☰"; // 햄버거 아이콘으로 변경
        }

        // 모든 표시를 초기화하는 함수
        function clearAllDisplays() {
            barcodeInput.textContent = '';
            indexNoDisplay.textContent = '';
            msCodeDisplay.textContent = '';
            serialNoDisplay.textContent = '';
            errorDisplay.textContent = '';
            baseCtx.clearRect(0, 0, baseImageCanvas.width, baseImageCanvas.height);
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            // 캔버스 컨테이너와 체크 완료 버튼을 숨깁니다.
            document.getElementById('canvasContainer').style.display = 'none';
            document.getElementById('checkCompleteButton').style.display = 'none';
        }

        function processBarcode(barcode) {
            clearAllDisplays();
            if (barcode.length === 6) {
                fetchIndexNo(barcode);
            } else {
                errorDisplay.textContent = '6자리의 Index No를 입력해주세요.';
            }
        }

        // 체크 완료 버튼 클릭 이벤트 핸들러
        document.getElementById('checkCompleteButton').addEventListener('click', function() {
            // 필요한 정보가 모두 있는지 확인
            if (!indexNoDisplay.textContent || !serialNoDisplay.textContent || !document.getElementById('deptInfo').textContent) {
                alert('바코드를 먼저 입력해주세요. 모든 필요한 정보가 로드되어야 합니다.');
                return;
            }

            const selectedProcess = document.getElementById('processSelect').value;
            let allChecked = true;
            let anyCrossed = false;

            // 부품SET(08)와 단자체결기(06)를 제외한 공정에서 모든 체크박스 확인 로직
            /*
            if (selectedProcess !== '08' && selectedProcess !== '06') {
                checkBoxes.forEach((box, index) => {
                    if (!(index in checkBoxStates) || checkBoxStates[index] === 'default') {
                        allChecked = false;
                    }            
                    if (checkBoxStates[index] === 'crossed') {
                        anyCrossed = true;
                    }
                });
                console.log(checkBoxStates);
                if (!allChecked) {
                    alert('모든 항목을 체크해주세요.');
                    return;
                }
            }
            */

            let result = anyCrossed ? 'NG' : 'OK';

            // 체크박스 상태와 위치를 서버로 전송
            const checkboxData = {
                indexNo: indexNoDisplay.textContent,
                serialNo: serialNoDisplay.textContent,
                deptCode: document.getElementById('deptInfo').textContent.split(' ')[0],
                processCode: selectedProcess,
                checkboxStates: checkBoxStates,
                checkboxPositions: checkBoxes.reduce((acc, box, index) => {
                    acc[index] = {
                        x: box.x,
                        y: box.y,
                        width: box.width,
                        height: box.height
                    };
                    return acc;
                }, {}),
                empNo: document.getElementById('employeeName').textContent.split(' ')[0]
            };

            fetch('/save_checkbox_states', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(checkboxData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Checkbox states and positions saved:', data);
                // 이미지 저장 로직
                const baseImageCanvas = document.getElementById('baseImageCanvas');
                const drawingCanvas = document.getElementById('drawingCanvas');
                const mergedCanvas = document.createElement('canvas');
                mergedCanvas.width = baseImageCanvas.width;
                mergedCanvas.height = baseImageCanvas.height;
                const mergedCtx = mergedCanvas.getContext('2d');
                mergedCtx.drawImage(baseImageCanvas, 0, 0);
                mergedCtx.drawImage(drawingCanvas, 0, 0);

                mergedCanvas.toBlob(function(blob) {
                    const formData = new FormData();
                    formData.append('image', blob, 'checked_image.png');
                    formData.append('serialNo', serialNoDisplay.textContent);
                    formData.append('processCode', selectedProcess);
                    formData.append('deptCode', document.getElementById('deptInfo').textContent.split(' ')[0]);
                    formData.append('empNo', document.getElementById('employeeName').textContent.split(' ')[0]);
                    formData.append('indexNo', indexNoDisplay.textContent);
                    formData.append('result', result);

                    fetch('/save_checked_image', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(imageData => {
                        console.log('Image saved:', imageData);
                        // alert('체크시트가 성공적으로 저장되었습니다.');
                        showMessage('체크시트가 성공적으로 저장되었습니다.', 'success');
                    })
                    .catch(error => {
                        console.error('Error saving image:', error);
                        // alert('이미지 저장 중 오류가 발생했습니다.');
                        showMessage('이미지 저장 중 오류가 발생했습니다.', 'error');
                    });
                });
            })
            .catch(error => {
                console.error('Error saving checkbox states and positions:', error);
                // alert('체크박스 상태와 위치 저장에 실패했습니다. 다시 시도해 주세요.');
                showMessage('체크박스 상태와 위치 저장에 실패했습니다. 다시 시도해 주세요.', 'error');
            });
        });

        // 페이지가 로드되면 바코드 입력 필드에 자동으로 포커스를 맞춥니다.
        window.onload = function() {
            document.getElementById('barcodeInput').focus();
        };

        // 문서 전체에 대해 키 다운 이벤트를 캡쳐하고, 이벤트가 발생할 때마다
        // 바코드 입력 필드로 포커스를 옮기고 입력을 리다이렉트합니다.
        document.addEventListener('keydown', function(event) {
            const barcodeInput = document.getElementById('barcodeInput');
            if (document.activeElement !== barcodeInput) {
                barcodeInput.focus();
                if (event.key.length === 1 && ((event.key >= '0' && event.key <= '9') || (event.key >= 'A' && event.key <= 'Z') || (event.key >= 'a' && event.key <= 'z'))) {
                    console.log(event.key);
                    barcodeInput.value = event.key; // 새로운 입력을 시작합니다.
                    const inputEvent = new Event('input', { bubbles: true });
                    barcodeInput.dispatchEvent(inputEvent); // 입력 이벤트를 트리거합니다.
                    event.preventDefault();
                }
            } else {
                if (barcodeInput.value.length == 6) {
                    processBarcode(barcodeInput.value);
                    barcodeInput.value = '';
                    event.preventDefault();
                }
            }
        }); 

        // 바코드 입력 필드에 keypress 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', () => {
            barcodeInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();  // 폼 자동 제출 방지

                    const barcode = barcodeInput.value.trim();
                    clearAllDisplays();
                    // 바코드가 6자리일 경우 처리 함수 호출
                    if (barcode.length === 6) {
                        fetchIndexNo(barcode);
                        barcodeInput.value = '';
                    } else {
                        // 입력 길이가 6자리가 아니면 에러 메시지 출력
                        errorDisplay.textContent = '6자리의 Index No를 입력해주세요.';
                    }
                }
            });
        });

        // DB에서 IndexNo를 조회하여 MSCODE, SerialNo 페이지에 표시하고 이미지를 로드합니다.
        const handleResponse = (data) => {
            // 응답에서 MS-CODE와 Serial No를 받아 페이지에 표시합니다.
            if (data.MS_CODE && data.Serial_No && data.Index_No) {
                indexNoDisplay.textContent = data.Index_No;
                msCodeDisplay.textContent = data.MS_CODE;
                serialNoDisplay.textContent = data.Serial_No;
                errorDisplay.textContent = '';  // 에러 메시지를 초기화합니다.

            } else {
                indexNoDisplay.textContent = 'Unavailable';
                msCodeDisplay.textContent = 'Unavailable';
                serialNoDisplay.textContent = 'Unavailable';
                errorDisplay.textContent = data.error || 'An error occurred';  // 에러 메시지를 표시합니다.
            }
        };
            
        // 바코드가 6자리 입력되면 호출되는 함수
        function fetchIndexNo(barcode) {
            fetch('/get_product_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({'indexNo': barcode})
            })
            .then(response => response.json())
            .then(data => {
                handleResponse(data);
                
                if (data.Serial_No) {
                    // 캔버스 컨테이너와 체크 완료 버튼을 표시합니다.
                    document.getElementById('canvasContainer').style.display = 'block';
                    document.getElementById('checkCompleteButton').style.display = 'inline-block';
                    
                    const processSelect = document.getElementById('processSelect');
                    const selectedIndex = processSelect.selectedIndex;
                    const selectedProcess = processSelect.options[selectedIndex].value;
                    const deptCode = document.getElementById('deptInfo').textContent.split(' ')[0];
                    console.log(deptCode);

                    const uploadImageUrl = `/upload_image/${data.Index_No}_${deptCode}_${data.Serial_No}_${selectedProcess}_${selectedIndex}`;

                    fetch(uploadImageUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('이미지를 서버에서 가져오는데 실패했습니다.');
                        }
                        return response.json();
                    })
                    .then(imageData => {
                        if (imageData.image_url) {
                            is_checked_image = imageData.is_checked_image;
                            loadImage(imageData.image_url);
                            checkBoxes = imageData.checkboxes || [];
                            // 체크박스 상태 불러오기
                            fetch(`/get_checkbox_states?indexNo=${encodeURIComponent(data.Index_No)}&serialNo=${encodeURIComponent(data.Serial_No)}&processCode=${encodeURIComponent(selectedProcess)}&deptCode=${encodeURIComponent(deptCode)}`)
                            .then(response => response.json())
                            .then(states => {
                                if (is_checked_image) {
                                    checkBoxStates = states;
                                } else {
                                    // is_checked_image가 false일 때 모든 체크박스 상태를 'default'로 설정
                                    checkBoxStates = {};
                                    checkBoxes.forEach((_, index) => {
                                        checkBoxStates[index] = 'default';
                                    });
                                }
                                redrawCheckboxes();
                            })
                            .catch(error => {
                                console.error('체크박스 상태 불러오기 오류:', error);
                            });
                        } else {
                            throw new Error('이미지 URL이 없습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('이미지 가져오기 오류:', error);
                        errorDisplay.textContent = '요청한 이미지가 존재하지 않습니다. Index No 바코드 혹은 공정을 확인해주세요.';
                    });
                }
            })
            .catch(error => {
                console.error('Index No 가져오기 오류:', error);
                errorDisplay.textContent = 'DB에서 정보를 조회할 수 없습니다.';
            });
        }

        // 바코드 입력 필드에 영문과 숫자만 입력 허용
        function validateInput(input) {
            // 입력된 문자를 영문 대문자로 변환
            input.value = input.value.toUpperCase();
            
            // 영문자와 숫자만 허용
            const alphanumericRegex = /[^A-Z0-9]/g;
            input.value = input.value.replace(alphanumericRegex, '');
            
            // 입력 길이가 변경되면 기존 정보 초기화
            if (input.value.length === 0 || input.value.length > 0) {
                clearAllDisplays();
            }
        }

        const LONG_PRESS_TIME = 1000; // 길게 누르기로 간주할 시간 (밀리초)
        let isLongPress = false; // 길게 누르기 상태를 저장하는 변수
        let drawing = false; // 그리기 상태
        // 우클릭 드래그를 감지하기 위한 변수
        let rightClickDragging = false;
        let startX, startY;  // 드래그 시작 좌표

        // 체크박스 영역을 나타내는 배열 (실제 사용 시 서버로부터 받아온 데이터 사용)
        let checkBoxes = [{ x: 50, y: 50, width: 20, height: 20 }]; // 예시 데이터
        // 체크박스 상태 관리
        // 각 체크박스에 대해 'default', 'checked', 'crossed' 등의 상태를 저장합니다.
        let checkBoxStates = {};

        // 이미지를 로드하는 함수
        function loadImage(url) {
            const image = new Image();
            image.onload = function() {
                baseImageCanvas.width = image.width;
                baseImageCanvas.height = image.height;
                drawingCanvas.width = image.width;
                drawingCanvas.height = image.height;
                baseCtx.drawImage(image, 0, 0);
                drawingCtx.drawImage(image, 0, 0);

                // 이미지 로드 후 해당 캔버스로 스크롤 이동
                document.getElementById('baseImageCanvas').scrollIntoView({ behavior: 'smooth' });

            };
            image.onerror = function() {
                // 이미지 로드에 실패한 경우 에러 처리
                console.error('Failed to load image at ' + url);
            };
            image.src = url;
        }

        // 그리기 시작
        drawingCanvas.onpointerdown = function(event) {
            event.preventDefault();
            isLongPress = false;
            let timer = setTimeout(() => isLongPress = true, LONG_PRESS_TIME);

            const {x, y} = getCursorPosition(event);

            // 우클릭 검사
            if (event.button === 2) {
                const {x, y} = getCursorPosition(event);
                if (!isInsideCheckbox(x, y)) {
                    rightClickDragging = true;
                    startX = x;
                    startY = y;
                    event.preventDefault();  // 컨텍스트 메뉴 방지
                }
            } else {
                // 체크박스 내부에서는 그리지 않음
                if (!isInsideCheckbox(x, y)) {
                    drawing = true;
                    drawingCtx.beginPath();
                    drawingCtx.moveTo(x, y);
                } else {
                    // 체크박스 내부에서 길게 눌렀을 때의 처리
                    document.body.addEventListener('pointerup', () => {
                        clearTimeout(timer);
                        if (isLongPress) {
                            redrawCheckbox(getCheckboxIndex(x, y));
                        }
                    }, {once: true});
                }
            }
        };

        // 그리기 진행
        drawingCanvas.onpointermove = function(event) {
            event.preventDefault();
            if (rightClickDragging) {
                const {x, y} = getCursorPosition(event);

                // 각 체크박스를 순회하면서 포인터 위치가 체크박스 내부인지 확인합니다.
                checkBoxes.forEach(function(checkBox, index) {
                    if (x >= checkBox.x && x <= checkBox.x + checkBox.width &&
                        y >= checkBox.y && y <= checkBox.y + checkBox.height) {
                        // 포인터가 체크박스 내부로 들어간 경우 상태를 default로 설정합니다.
                        checkBoxStates[index] = 'default';

                        // 선택적으로 체크박스 상태가 변경됨을 사용자에게 시각적으로 표시할 수 있습니다.
                        clearCheckboxVisual(index);
                    }
                });

                eraseLine(startX, startY, x, y);
                startX = x;
                startY = y;
            } else {
                if (drawing) {
                    const {x, y} = getCursorPosition(event);
                    drawingCtx.lineTo(x, y);
                    drawingCtx.strokeStyle = 'blue';
                    drawingCtx.lineWidth = 2;
                    drawingCtx.stroke();
                }
            }
        };

        // 그리기 종료
        drawingCanvas.onpointerup = function(event) {
            event.preventDefault();
            if (event.button === 2 && rightClickDragging) {
                rightClickDragging = false;
            } else {
                if (drawing) {
                    drawingCtx.closePath();
                    drawing = false;
                }
            }
        };

        drawingCanvas.onpointerleave = function(event) {
            event.preventDefault();
            if (drawing) {
                drawingCtx.closePath();
                drawing = false;
            }
        };

        // 커서 위치 계산
        function getCursorPosition(event) {
            const rect = drawingCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            return { x, y };
        }
        // 체크박스 내부 확인
        function isInsideCheckbox(x, y) {
            return checkBoxes.some(box => 
                x >= box.x && x <= box.x + box.width && y >= box.y && y <= box.y + box.height
            );
        }

        // 체크박스 인덱스 가져오기
        function getCheckboxIndex(x, y) {
            return checkBoxes.findIndex(box => 
                x >= box.x && x <= box.x + box.width && y >= box.y && y <= box.y + box.height
            );
        }

        function processClick(event) {
            if (isLongPress) return; // 길게 누르기 상태에서는 추가 동작을 수행하지 않음

            const rect = drawingCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            checkBoxes.forEach(function(checkBox, index) {
                const centerX = checkBox.x + checkBox.width / 2;
                const centerY = checkBox.y + checkBox.height / 2; // Y 위치 조정

                if (x >= checkBox.x && x <= (checkBox.x + checkBox.width) &&
                    y >= checkBox.y && y <= (checkBox.y + checkBox.height)) {
                    const state = checkBoxStates[index] || 'default';

                    if (event.button === 0 && state === 'default') { // 왼쪽 버튼 클릭 및 상태 확인
                        drawCheck(centerX, centerY);
                        checkBoxStates[index] = 'checked';
                    } else if (event.button === 2 && state === 'default') {
                        drawCross(centerX, centerY);
                        checkBoxStates[index] = 'crossed';
                    }
                }
            });
        }

        // 각 도형을 체크박스 가운데에 그리는 함수
        function drawCheck(x, y) {
            drawingCtx.beginPath();
            drawingCtx.moveTo(x - 5, y - 5); // V자의 시작 위치를 조정
            drawingCtx.lineTo(x, y + 5);
            drawingCtx.lineTo(x + 5, y - 5);
            drawingCtx.strokeStyle = 'blue';
            drawingCtx.lineWidth = 2;
            drawingCtx.stroke();
        }
        function drawCross(centerX, centerY) {
            let lineLength = 10; // X자를 그릴 때 각 선의 길이

            drawingCtx.beginPath();
            // 왼쪽 위에서 시작하여 오른쪽 아래로 선을 그립니다.
            drawingCtx.moveTo(centerX - lineLength / 2, centerY - lineLength / 2);
            drawingCtx.lineTo(centerX + lineLength / 2, centerY + lineLength / 2);
            // 오른쪽 위에서 시작하여 왼쪽 아래로 선을 그립니다.
            drawingCtx.moveTo(centerX + lineLength / 2, centerY - lineLength / 2);
            drawingCtx.lineTo(centerX - lineLength / 2, centerY + lineLength / 2);

            drawingCtx.strokeStyle = 'red';
            drawingCtx.lineWidth = 2;
            drawingCtx.stroke();
        }

        // 동그라미와 체크를 그리는 함수
        function drawCircleAndCheck(centerX, centerY) {
            // 체크박스 중심에 원 그리기
            drawingCtx.beginPath();
            drawingCtx.arc(centerX, centerY, 10, 0, Math.PI * 2);
            drawingCtx.strokeStyle = 'red';
            drawingCtx.lineWidth = 2;
            drawingCtx.stroke();

            // 원 안에 X 그리기
            let lineLength = 10;
            drawingCtx.beginPath();
            drawingCtx.moveTo(centerX - lineLength / 2, centerY - lineLength / 2);
            drawingCtx.lineTo(centerX + lineLength / 2, centerY + lineLength / 2);
            drawingCtx.moveTo(centerX + lineLength / 2, centerY - lineLength / 2);
            drawingCtx.lineTo(centerX - lineLength / 2, centerY + lineLength / 2);
            drawingCtx.strokeStyle = 'red';
            drawingCtx.lineWidth = 2;
            drawingCtx.stroke();

            // 원의 우측에 V표시 추가
            drawCheck(centerX + 15, centerY);
        }
        function clearCheckboxVisual(index) {
            const checkBox = checkBoxes[index];
            // 체크박스 영역과 그 주변을 더 넓게 지웁니다.
            drawingCtx.clearRect(checkBox.x - 20, checkBox.y - 10, checkBox.width + 40, checkBox.height + 20);
        }

        // 지우개 기능을 수행하는 함수
        function eraseLine(x0, y0, x1, y1) {
            drawingCtx.globalCompositeOperation = 'destination-out';  // 현재 그려진 내용 지우기
            drawingCtx.beginPath();
            drawingCtx.moveTo(x0, y0);
            drawingCtx.lineTo(x1, y1);
            drawingCtx.strokeStyle = 'rgba(0,0,0,1)';
            drawingCtx.lineWidth = 20;  // 지우개 선의 너비
            drawingCtx.stroke();
            drawingCtx.globalCompositeOperation = 'source-over';  // 다시 일반적인 드로잉 모드로 복귀
        }
        
        // 체크박스 초기화 및 다시 그리기
        function redrawCheckBox(index) {
            const checkBox = checkBoxes[index];
            // Clear the checkbox area
            drawingCtx.clearRect(checkBox.x, checkBox.y, checkBox.width, checkBox.height);
            // Optionally, redraw the checkbox border or background for visual clarity
            drawingCtx.strokeStyle = 'red';
            drawingCtx.strokeRect(checkBox.x, checkBox.y, checkBox.width, checkBox.height);
            checkBoxStates[index] = 'default';
        }

        // 체크박스 상태에 따라 이미지 그리기
        function redrawCheckboxes() {
            checkBoxes.forEach((box, index) => {
                const state = checkBoxStates[index] || 'default';
                const centerX = box.x + box.width / 2;
                const centerY = box.y + box.height / 2;
                
                switch (state) {
                    case 'checked':
                        drawCheck(centerX, centerY);
                        break;
                    case 'crossed':
                        drawCross(centerX, centerY);
                        break;
                    case 'rechecked':
                        drawCircleAndCheck(centerX, centerY);
                        break;
                }
            });
        }

        // 세션 확인 함수
        function checkSession() {
            return fetch('/check_login_status')
                .then(response => response.json())
                .then(data => {
                    if (!data.loggedIn) {
                        alert('로그인 후에 계속해주세요.');
                        window.location.href = '/login';
                        return false;
                    }
                    return true;
                })
                .catch(error => {
                    console.error('세션 확인 중 오류 발생:', error);
                    return false;
                });
        }

        function showMessage(message, type = 'error', duration = 3000) {
            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer) {
                console.error('messages-container 요소를 찾을 수 없습니다.');
                return;
            }
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            // 타입에 따라 배경색 변경
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#4CAF50'; // 녹색
            } else if (type === 'info') {
                messageDiv.style.backgroundColor = '#2196F3'; // 파란색
            } else {
                messageDiv.style.backgroundColor = '#f44336'; // 기본 빨간색
            }

            // Serial No 가져오기
            const serialNo = document.getElementById('serialNo').textContent || 'N/A';

            // 메시지와 Serial No를 함께 표시
            messageDiv.innerHTML = `<p>${message}</p><p><strong>Serial No:</strong> ${serialNo}</p>`;
            messagesContainer.appendChild(messageDiv);

            // 설정된 시간이 지나면 메시지 숨기기
            setTimeout(() => {
                messageDiv.classList.add('hide');
                // 애니메이션이 끝난 후 DOM에서 제거
                messageDiv.addEventListener('transitionend', () => {
                    messageDiv.remove();
                });
            }, duration);
        }
    </script>
</body>
</html>